= cockpit 
Nick Hardiman
:source-highlighter: pygments
:toc: 
:revdate: 01-06-2020


https://cockpit-project.org/[Cockpit] is a server management system with a web-based control panel.

https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/managing_systems_using_the_rhel_8_web_console/index[cockpit] 
is installed on RHEL 8 hosts, but not enabled. 

Connecting to a RHEL 8 host displays an MOTD (Message of the Day) that lets the user know cockpit is waiting to be enabled.

[source,console]
----
somehost:~ nick$ ssh 10.0.1.45
Activate the web console with: systemctl enable --now cockpit.socket

Last login: Thu May 14 17:29:53 2020 from 10.0.1.3
[nick@rhel8 ~]$ 
----

== components 

* https://cockpit-project.org/guide/133/cockpit-bridge.1.html
* https://cockpit-project.org/guide/149/cockpit-ws.8.html


== enable cockpit 

Enable and start the systemd unit cockpit.socket. 
Connecting to the socket starts cockpit.service.

[source,console]
....
[nick@host ~]$ systemctl status cockpit.socket
â— cockpit.socket - Cockpit Web Service Socket
   Loaded: loaded (/usr/lib/systemd/system/cockpit.socket; disabled; vendor pre>
   Active: inactive (dead)
     Docs: man:cockpit-ws(8)
   Listen: [::]:9090 (Stream)
[nick@host ~]$ 
[nick@host ~]$ sudo systemctl enable --now cockpit.socket
[sudo] password for nick: 
Created symlink /etc/systemd/system/sockets.target.wants/cockpit.socket â†’ /usr/lib/systemd/system/cockpit.socket.
[nick@host ~]$ 
....

After it's enabled, the MOTD message changes. 

[source,console]
----
somehost:~ nick$ ssh 10.0.1.45
Web console: https://host.lab.example.com:9090/ or https://10.0.1.40:9090/

Last login: Thu May 14 17:29:53 2020 from 10.0.1.3
[nick@rhel8 ~]$ 
----


== web browser 

The service is available on port 9090, with an URL along the lines of https://10.0.1.45:9090/.

The default server config uses a self-signed certificate.

[source,console]
----
[nick@guest1 ~]$ sudo remotectl certificate
[sudo] password for nick: 
certificate: /etc/cockpit/ws-certs.d/0-self-signed.cert
[nick@guest1 ~]$ 
----

 Web browsers don't like self-signed certificates. 
 Chrome displays this warning.

[source,console]
----
Your connection is not private
Attackers might be trying to steal your information from 10.0.1.45 (for example, passwords, messages or credit cards). Learn more
NET::ERR_CERT_AUTHORITY_INVALID
----

Luckily it still offers the option to `Proceed to 10.0.1.45 (unsafe)`.

Chrome continues to cause problems behind the scenes. 
The journal may contain many _gnutls_handshake_ errors. 

[source,console]
----
[nick@guest1 ~]$ sudo journalctl -f
...
Jul 23 17:43:02 host1 cockpit-tls[14712]: cockpit-tls: gnutls_handshake failed: A TLS fatal alert has been received.
----

== one cockpit, many servers 

Add a hostname onto the end of the URL. 
https://10.0.1.40:9090/@guest2.lab.example.com

First attempt shows

[source,console]
----
Couldn't connect to the machine 
Cannot connect to an unknown machine 
Troubleshoot 
----

Troubleshoot button displays a second page.

[source,console]
----
Add machine to dashboard 
Address 192.168.122.3
Color 
Cancel Add 
----


Servers are copied to the config file 
/etc/cockpit/machines.d/99-webui.json.


== satellite integration 

https://100things.wzzrd.com/2018/06/27/Running-cockpit-on-a-Satellite-Capsule-Foreman-Proxy.html[Running cockpit on a Satellite Capsule / Foreman Proxy]

https://theforeman.org/plugins/foreman_remote_execution/1.7/index.html

3.6 Cockpit integration

To automatically sign to managed hostâ€™s Cockpit web interface, click on â€œWeb Consoleâ€ button on the host detail page. The button only appears when plugin was installed with --enable-foreman-proxy-plugin-remote-execution-cockpit option. The managed host must also have the cockpit-system package installed.

Chris Proctor's mail 

On the satellite server you need to do:

[source,console]
----
foreman-installer --scenario satellite --enable-foreman-plugin-remote-execution-cockpit
----

which adds the "web console" button to the satellite gui. Thats the bit I'd missed ðŸ™„


Then on the client you need to install the packages with `yum install cockpit`.

You don't need to enable the socket or anything like that, just install the packages.

You also need to allow the foreman-proxy to login to the server via ssh without a password.

[source,console]
----
ssh-copy-id ~foreman-proxy/.ssh/id_rsa_foreman_proxy.pub root@client
----

If you want to use a different user then you can change the user the remote execution uses to log in. In satellite go to Administer-> Settings and on the Remote Execution tab change the  "SSH User" setting to a valid user on the client, then use ssh-copy-id to copy the foreman-proxy user's ssh key to the appropriate home directory on the client, e.g.:

[source,console]
----
ssh-copy-id ~foreman-proxy/.ssh/id_rsa_foreman_proxy.pub user@client
----

and at that point the "web console" button will take you into cockpit running as the non-privileged user, so you will be able to view settings, but to change them you will need the appropriate sudo settings.

Cockpit itself works by having a web interface (running on the satellite in our case) that talks to the client using ssh as a transport mechanism, but instead of running a bash shell on the client it runs cockpit-bridge which uses the cockpit pam stack to authenticate and can run commands, talk to dbus etc and sends the results back in a way the gui can understand. So we need ssh ports open between the satellite and the client but shouldn't need anything else.


